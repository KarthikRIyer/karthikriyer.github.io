<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Granular Simulation with Position Based Dynamics | Karthik Ramesh Iyer </title> <meta name="author" content="Karthik Ramesh Iyer"> <meta name="description" content="CS grad student at Texas A&amp;M University "> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://karthikriyer.github.io/blog/2024/pbd-grains/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Karthik</span> Ramesh Iyer </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Granular Simulation with Position Based Dynamics</h1> <p class="post-meta"> Created on December 01, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/animation"> <i class="fa-solid fa-hashtag fa-sm"></i> animation</a>   <a href="/blog/tag/physically-based-modelling"> <i class="fa-solid fa-hashtag fa-sm"></i> physically-based-modelling</a>   ·   <a href="/blog/category/project"> <i class="fa-solid fa-tag fa-sm"></i> project</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <figure> <iframe src="https://www.youtube.com/embed/OMciaBM2g_A" class="img-fluid rounded z-depth-1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="" width="auto" height="auto" min-width="1000"></iframe> </figure> <h1 id="overview">Overview</h1> <p>Granular material like sand and dirt is commonplace. Simulating such material is challenging because the behavior of the whole mass depends on the interactions between individual particles. Methods used in engineering, like Discrete Element Method are accurate but very slow, making them non-interactive and unusable for Computer Graphics.</p> <p>The main behavior contributing to the realistic behavior of granular material is forming piles. An approximate model mimicking this behavior can add significant realism to scenes. The paper titled ”Unified Particle Physics for Real-Time Applications” by Macklin, et. al. proposes a friction model that accounts for relative tangential motion between particles based on friction coefficients and particle penetration distance. The model uses Position Based Dynamics (PBD), a position-based simulation method where particle positions can be updated without an integration step. Although inaccurate, it gives visually plausible results.</p> <h1 id="algorithm-and-results">Algorithm and Results</h1> <p>The algorithm uses standard position based dynamics to solve constraints:</p> <p>The technique proposed by Müller, et.al. introduces intentional numerical damping to hide the uneven mass distribution inherent to FTL. The steps for dynamic FTL with damping are:</p> <p>\(\Delta x_{i}^c = \lambda_i \nabla C(\vec{x})\) <br> \(\lambda_i = \frac{1}{m_i} \frac{C(\vec{x})}{|\nabla C(\vec{x})|^2}\) <br></p> <p>First, we use the distance constraint to resolve inter-particle contacts:</p> <p><br> \(C(x_i, x_j) = |x_{ij} - r| \ge 0\) <br></p> <p>The gradient of the above constraint is the contact normal: \(\vec{n} = x_i - x_j\) <br></p> <p>Once the distance constraints are solved, we handle friction by getting rid part of the relative tangential motion between particles. The first image below shows the initial position of the particles with interpenetration. Gravity pulls the first particle downwards and the collision constraint pushes the particle along the collision vector. The second image shows what could have been the state after collision resolution without friction handling. The friction model proposed by Macklin et. al. calculates the position delta component perpendicular to the collision vector, and decreases it according to chosen friction coefficients and interpenetration distance. This model adds support for static friction by getting rid of the tangential component completely in certain scenarios as described by the model below.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/pbd-grains-algo-before-after-480.webp 480w,/assets/img/pbd-grains-algo-before-after-800.webp 800w,/assets/img/pbd-grains-algo-before-after-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/pbd-grains-algo-before-after.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p><br></p> <p>\(\begin{equation} \Delta x_{i}^f = \frac{w_i}{w_i + w_j} \begin{cases} \Delta x_\perp, &amp; |\Delta x_\perp &lt; \mu_s d|\\ \Delta x_\perp \cdot min(\frac{\mu_k d}{\Delta x_\perp}, 1) &amp; \text{otherwise} \end{cases} \end{equation}\) <br> <br> The final position delta for each particle would be: \(\Delta x = \Delta x_{i}^c + \Delta x_{i}^f\)</p> <p>Finally we update particles velocities: \(\Delta v = \frac{\Delta x}{\Delta t}\)</p> <p>Additionally, as proposed by Macklin et. al. we solve the constraints in parallel (on the CPU using OneTBB, in the current implementation) and average the position deltas per particle by dividing the calculated position delta by the number of constraints for that particle: <br> \(\Delta \tilde{x_i}\ = \frac{1}{n_i} \Delta x_i\)</p> <h2 id="collisions-with-objects">Collisions with objects</h2> <p>The model proposed by Macklin et. al. handles collisions and friction contact with all objects by representing objects as collections of particles and using the above mentioned contact constraints. This would involve generating tightly packed points on mesh surfaces, and use the above mentioned contact constraints. But, to keep things simple, my implementation handles mesh collisions naively by checking point-triangle intersections. To demonstrate formation of piles, we generate a horizontal grid of particles in place of a floor.</p> <h2 id="spatial-hashing">Spatial Hashing</h2> <p>Particle collision detection involves checking particle neighbours for interpenetration. Doing this naively would be to check all particle pairs, resulting in an \(O(n^2)\) operation. For large number of particles this soon becomes intractable. We use spatial hashing to distribute particles on a grid and check particles in the neighbouring grids for collisions. This significantly reduces the number of particle pairs to check. We use the spatial hashing function and algorithm proposed by Matthias Müller: <a href="https://youtu.be/D2M8jTtKi44?si=_j6idhZJdrf6W-Rn" rel="external nofollow noopener" target="_blank">Finding collisions among thousands of objects blazing fast</a> <br> Here is the used hash function: <br></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    xi = floor(px / grid size)
    yi = floor(px / grid size)
    zi = floor(px / grid size)

    hashCoords(xi, yi, zi) {
        h = (xi * 92837111) ^ (yi * 689287499) ^ (zi * 283923481)
        return abs(h) % numberOfCells
    }
</code></pre></div></div> <p><br></p> <h2 id="generating-particle-clusters-and-rendering-with-blender">Generating particle clusters and rendering with Blender</h2> <p>To demonstrate different visual results we generate grains in the volume of meshes. Blender’s geometry nodes allows us to visually program geometric manipulations. This is much faster than using python scripts in Blender since geometry nodes are implemented in C++ under the hood. We use the following geometry node setup (from Ducky 3D’s YouTube tutorial: <a href="https://youtu.be/mQn8P0MLE48?si=G_E_p5scnJHmEhfh" rel="external nofollow noopener" target="_blank">Filling objects is easy now</a>) to generate particles inside meshes. Although not tightly packed, it gives visually reasonable results.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/point-gen-geom-nodes-480.webp 480w,/assets/img/point-gen-geom-nodes-800.webp 800w,/assets/img/point-gen-geom-nodes-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/point-gen-geom-nodes.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p><br></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    generate points in mesh:
        convert mesh to volume (voxelize mesh)
        generate points in volume
        for i in 1...4
            merge points within distance of 2 * particleRadius
</code></pre></div></div> <p>To improve the visual quality of the final results we export particle positions to blender and use the Cycles rendering engine for final images:</p> <ul> <li>Export per-timestep list of points from simulator to a text file</li> <li>Convert list of points to per-timestep ply files using a python script</li> <li>Use a blender python script to import ply files for each frame, and keyframe object visibility per-frame (since you cannot explicitly import objects for each frame)</li> </ul> <h2 id="results">Results</h2> <p>Dam break simulations eventually form piles of grains as expected.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/dam-break-init-480.webp 480w,/assets/img/dam-break-init-800.webp 800w,/assets/img/dam-break-init-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/dam-break-init.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/dam-break-pile-480.webp 480w,/assets/img/dam-break-pile-800.webp 800w,/assets/img/dam-break-pile-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/dam-break-pile.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/funnel-init-480.webp 480w,/assets/img/funnel-init-800.webp 800w,/assets/img/funnel-init-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/funnel-init.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/funnel-pile-480.webp 480w,/assets/img/funnel-pile-800.webp 800w,/assets/img/funnel-pile-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/funnel-pile.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/text-init-480.webp 480w,/assets/img/text-init-800.webp 800w,/assets/img/text-init-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/text-init.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/text-pile-480.webp 480w,/assets/img/text-pile-800.webp 800w,/assets/img/text-pile-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/text-pile.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/text-init-render-480.webp 480w,/assets/img/text-init-render-800.webp 800w,/assets/img/text-init-render-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/text-init-render.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/text-pile-render-480.webp 480w,/assets/img/text-pile-render-800.webp 800w,/assets/img/text-pile-render-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/text-pile-render.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/csce-render-480.webp 480w,/assets/img/csce-render-800.webp 800w,/assets/img/csce-render-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/csce-render.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h2 id="code-repository">Code Repository</h2> <p>GitHub Repo: <a href="https://github.com/KarthikRIyer/CSCE-649-Physically-Based-Modeling/tree/main/pbd-grains" rel="external nofollow noopener" target="_blank">pbd-grains</a></p> <h2 id="acknowledgements">Acknowledgements</h2> <ul> <li>The OpenGL boilerplate code has been borrowed from Prof. Sueda’s assignment material and has been modified for OpenGL 4.x.</li> <li>The project is based on the papers: “<a href="https://mmacklin.com/uppfrta_preprint.pdf" rel="external nofollow noopener" target="_blank">Unified Particle Physics for Real-Time Applications</a>” by Macklin, et.al.</li> <li> <a href="https://github.com/g-truc/glm" rel="external nofollow noopener" target="_blank">GLM</a> and <a href="https://eigen.tuxfamily.org/index.php?title=Main_Page" rel="external nofollow noopener" target="_blank">Eigen</a> were used for vector math</li> <li> <a href="https://github.com/oneapi-src/oneTBB" rel="external nofollow noopener" target="_blank">oneTBB</a> was used for multi-threading</li> <li>Spatial hashing algorithm by Matthias Müller: <a href="https://youtu.be/D2M8jTtKi44?si=_j6idhZJdrf6W-Rn" rel="external nofollow noopener" target="_blank">Finding collisions among thousands of objects blazing fast</a> </li> <li>Ducky 3D’s YouTube tutorial: <a href="https://youtu.be/mQn8P0MLE48?si=G_E_p5scnJHmEhfh" rel="external nofollow noopener" target="_blank">Filling objects is easy now</a> </li> </ul> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/hair-sim/">Hair Simulation with Position Based Dynamics</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/gsoc-20-final-report-copy/">GSoC '20 Final Report</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2019/gsoc-19-final-report/">GSoC '19 Final Report</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2019/gsoc-coding-phase-part-4/">GSoC Coding Phase - Part 4</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2019/gsoc-coding-phase-part-3/">GSoC Coding Phase - Part 3</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Karthik Ramesh Iyer. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>